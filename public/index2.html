<!DOCTYPE html>
<html lang="en">

<head>
    <title>Blackbeard</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <script src="/jquery/dist/jquery.min.js"></script>
    <link defer type="text/css" rel="stylesheet" href="/bootstrap/dist/css/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="/css/index.css">
    <link defer rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.css" integrity="sha256-46qynGAkLSFpVbEBog43gvNhfrOj+BmwXdxFgVK/Kvc=" crossorigin="anonymous">
    <script src="/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/tween.umd.js"></script>
    <!-- <script src="/search.js" type="module"></script> -->
    <!-- <script src="https://cdn.socket.io/socket.io-1.7.3.js"></script> -->
    <script src="http://localhost:4000/socket.io/socket.io.js" type="text/javascript"></script>
</head>

<body>
	<div class="game-screen d-flex flex-column align-items-center">
		<div class="main-logo mb-2 mt-auto">
			<i class="fas fa-meteor fa-3x text-warning"></i>
		</div>
		<h3 class="mt-2">
			Particles
		</h3>
		<div class="d-flex flex-row game-screen-options init-loading justify-content-center mt-3 w-100 text-black-50">
			<span class="loading mr-2">Loading</span>
			<span>
				<i class="fas fa-spinner fa-spin fa-fw fa-lg"></i>
			</span>
		</div>
		<div class="input-group game-screen-options hide mb-auto">
	        <div class="input-group game-screen-options hide mb-auto">
	            <button class="btn btn-outline-secondary init-btn m-auto btn-block" type="button">Initiate</button>
	        </div>
		</div>
	</div>
    <div class="torrents-container d-flex flex-column w-100">

    </div>

    <div class="card rounded-0 mb-2 right-panel position-fixed" style="">
        <div class="card rounded-0 mb-2 right-panel-outer position-absolute" style="">
            <div class="d-flex flex-column">
                <h4 class="p-3 card-title d-flex align-items-center">
                    Episodes
                </h4>
                <div class="ep-container"></div>
            </div>
        </div>
        <div class="card rounded-0 mb-2 right-panel-inner position-absolute" style="">
            <div class="tv-show-poster-img"></div>
            <a href="#" class="p-3 text-center is-subscribed-btn btn btn-primary btn-block rounded-0 border-0"></a>
            <div class="p-3 d-flex flex-column">
                <h4 class="card-title d-flex align-items-center tv-show-title">
                    Title
                </h4>
                <small class="text-muted tv-show-actors"></small>
                <p class="tv-show-plot"></p>
            </div>
        </div>
        <div class="p-3 d-flex flex-column dragonfly-search-panel">
            <h4 class="card-title d-flex align-items-center">
                Search
                <small class="df-result-small text-muted ml-auto mr-2"></small>
            </h4>
            <div class="form-group m-0">
                <div class="form-label-group">
                    <input autocomplete="new-password" name="dragonflySearch" id="dragonflySearch" class="w-100 form-control mr-sm-2" placeholder="TV show title" aria-label="TV show title" value="">
                    <label for="dragonflySearch" class="cutoff">TV show title</label>
                </div>
            </div>
        </div>
        <div style="" class="d-flex flex-column selected-list-rp flex-fill"></div>
    </div>

    <div class="align-items-center bottom-card position-fixed align-items-stretch rounded-0 w-100 d-flex">
        <div class="d-flex flex-row btn-group tor-toolbar">
            <div class="btn-group dropup">
                <button type="button" class=" no-arrow btn btn-dark btn-lg dropdown-toggle rounded-0" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="fas fa-cloud-download-alt fa-fw"></i>
                </button>
                <div class="dropdown-menu rounded-0 m-0" aria-labelledby="dropdownMenu2">
                    <button class="dropdown-item stop-btn" type="button">Stop all</button>
                    <button class="dropdown-item start-btn" type="button">Start all</button>
                    <button class="dropdown-item remove-btn" type="button">Remove all</button>
                    <button class="dropdown-item sort-btn" type="button">Sort torrents</button>
                </div>
            </div>
            <div class="btn-group dropup">
                <button type="button" class=" add-dropdown-toggle no-arrow btn-dark btn-lg btn dropdown-toggle rounded-0" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="fas fa-plus fa-fw"></i>
                </button>
                <div class="dropdown-menu p-0 rounded-0 m-0">
                    <textarea class="form-control magnet-link-textarea" placeholder="paste magnet link here"></textarea>
                    <button class="add-magnet-btn btn btn-dark rounded-0 w-100" href="#">Add torrent</button>
                </div>
            </div>
            <button class=" show-search-btn no-arrow btn btn-dark btn-lg rounded-0">
                <i class="fas fa-tv fa-fw"></i>
            </button>
            <div class="btn-group dropup">
                <button type="button" class="no-arrow btn btn-dark btn-lg dropdown-toggle rounded-0" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="fas fa-skull text-warning fa-fw"></i>
                </button>
                <div class="dropdown-menu rounded-0 m-0" aria-labelledby="dropdownMenu2">
                    <button class="dropdown-item restart-daemon-btn" type="button">Restart daemon</button>
                    <button class="dropdown-item utility-btn" type="button">Uitility action</button>
                </div>
            </div>
        </div>
        <div class="d-flex w-100 position-relative bg-warning">
            <h4 class="d-none masthead-brand position-absolute d-sm-flex flex-column align-self-center ml-3">
                Blackbeard
            </h4>
            <small class="console-log ml-auto my-1 mr-3 d-flex flex-column align-items-end"></small>
        </div>
    </div>

    <div class="console-log-panel">
        <small class="console-log ml-auto my-1 mr-3 d-flex flex-column align-items-end"></small>
    </div>

    <script type="module">
        import Search from './js/search.js'

        var searchterm = "";

        var showSearch;

        var allShows;


        var activeTorrents, updateLoop, listLoop, displayLoop, cleanupLoop, animateLoop, tids, prevtime;

        var activeTorrents = [];

        var torrs = [];

        var avgTimeLeft;

        var latestUpdateTime;

        var feeds = [];

        var rpmd = false;

        var uiInitiated = false;

        var socket;

        var lastSort = 0;

        var consoleLog = [];

        function updateConsole(msg) {
            consoleLog.push( msg );
            let mainLog = $(".bottom-card .console-log");
            let overflowLog = $(".console-log-panel .console-log");

            mainLog.html('');
            consoleLog.slice(Math.max(consoleLog.length - 2, 0)).forEach((logMsg)=>{
                mainLog.append(`
                    <span class="console-msg">${logMsg}</span>
                `);
            });

            if(consoleLog.length>2) {
                let overflowMsg = consoleLog[consoleLog.length - 3];
                let newMsg = $(`<span class="console-msg">${overflowMsg}</span>`);
                overflowLog.append(newMsg);
                setTimeout(()=>newMsg.addClass("init"), 50);
                setTimeout(()=>newMsg.remove(), 12000);
            }
        }

        function getShows() {
            socket.emit('Shows.getAllShows')
        }

        function socketListenersOn() {

            socket.on('connect', function(res) {
                console.log("connected!");
                onSocketConnection();
            });

            socket.on('msg', (msg) => { updateConsole(msg); });

            socket.on('Shows.getAllShows', function(data) {
                allShows = [];
                var rt;
                data.forEach((show) => {
                    rt = 3
                    if (show.omdb != undefined) {
                        if (show.omdb.Response == "False") {
                            // console.log(show)
                        } else {
                            rt = parseFloat(show.omdb.imdbRating)
                        }
                    }
                    allShows.push({
                        term: show.name,
                        id: show.id,
                        omdb: show.omdb,
                        preMultiply: rt,
                        subscribed: show.subscribed
                    })
                })
                console.log("Show index reloaded.")
            });

            socket.on('Shows.get-rss-feed', function(feed) {
                // console.log(feed)
                var quality;
                var icon = `<i class="fas fa-cloud-download-alt p-4 ml-auto"></i>`;
                $(".ep-container").html('');
                // debugger
                feed.items.forEach((ep) => {
                    quality = "";
                    var epDetails = ep.title.match(/(\d+)x(\d{1,3})/gi);
                    var season = ep.title;
                    console.log(ep)
                    if (epDetails) {
                        console.log(epDetails)
                        season = epDetails[0];
                    }
                    $(".ep-container").append(
                        `<a data-magnet-link="${ep.link}" data-show-id="${feed.id}" href="#" class="add-ep-magnet-btn btn btn-block py-0 pl-3 pr-0 mt-0 rounded-0 d-flex flex-row ep-result-btn align-items-center border-top-0">
                            <div class="text-truncate m-3">
                                <h6 class="text-left text-truncate m-0">
                                    ${season}
                                </h6>
                               <small class="text-left text-secondary text-truncate">${quality}</small>
                            </div>
                            ${icon}
                        </a>`
                    );
                });
            });

            socket.on('Shows.toggleSubscribed', function(res) {
                allShows.find(x=>x.id==res.id).subscribed = res.subscribed;
            });

            socket.on('BlackbeardTransmission.get-info', function(torrents) {
                if(torrents.length!=0) {

                    torrents.forEach((torrent)=>{

                        if(torrent.percentDone==1) {
                            if((Date.now()-lastSort)>15000) {
                                socket.emit('BlackbeardTransmission.sort');
                                lastSort = Date.now();
                                console.log("Sorting torrents.");
                            }
                        }
                        if(!activeTorrents.find(x=>x.id==torrent.id)) {
                            activeTorrents.push( torrent )
                        }
                        if ($(".torrent-container-" + torrent.id).length == 0) {
                            // draw torrent
                            var percent = Math.round(torrent.percentDone * 10000) / 100 + "%";
                            var widthperc = Math.round(torrent.percentDone * 10000) / 100;
                            if (parseFloat(widthperc) > !9) {
                                widthperc = '';
                            } else {
                                widthperc = widthperc + "%";
                            }
                            var timeleft = (Math.round(torrent.leftUntilDone / torrent.rateDownload));
                            if (torrent.rateDownload == 0) {
                                timeleft = "--";
                            } else {
                                avgTimeLeft = Math.round(timeleft);
                                var minutesleft = Math.floor(avgTimeLeft / 60);
                                var secondsleft = Math.floor(avgTimeLeft % 60);
                                if (secondsleft < 10) {
                                    secondsleft = "0" + secondsleft;
                                }
                                timeleft = minutesleft + ":" + secondsleft;
                            }
                            // torrent.name = torrent.name.replace(/x264|AC3|mp4|mkv|\+|[\[\]\(\)]/gi, "");
                            torrent.torrentView = `
                            <div class="d-flex flex-row w-100 mb-2">
                                <div class="torrent-name text-truncate">${torrent.name}</div>
                                <div class="time ml-auto" data-prevtime=0>${timeleft}</div>
                            </div>
                            `;
                            if(torrent.data) {
                                let show = allShows.find(x=>x.id==parseInt(torrent.data.id));
                                torrent.showName = show.term;
                                torrent.details = torrent.name.matchAll(/(.*?)[\.\+\s]S(\d{1,2})E(\d{2})/gi);
                                for (const match of torrent.details) {
                                  torrent.season = match[2];
                                  torrent.seasonEp = match[3];
                                }
                                let hideStartBtn;
                                switch(torrent.status) {
                                    case 4:
                                        hideStartBtn = true;
                                    break;
                                    case 0:
                                        hideStartBtn = false;
                                    break;
                                }
                                torrent.torrentView = `
                                <div class="d-flex flex-row w-100 mb-2">
                                    <h5 class="torrent-show-name w-100">${torrent.showName}<br>
                                        <small class="text-muted">season ${torrent.season}, episode ${torrent.seasonEp}</small>
                                    </h5>
                                    <div class="d-flex flex-column">
                                        <div class="time ml-auto" data-prevtime=0>${timeleft}</div>
                                        <div class="d-flex align-self-end">
                                            <button class="btn btn-warning btn-sm rounded-0 border-0 ${!hideStartBtn ? 'hide ' : ''}stop-torrent-btn" data-tid=${torrent.id}>Stop</button>
                                            <button class="btn btn-primary btn-sm rounded-0 border-0 ${hideStartBtn ? 'hide ' : ''}start-torrent-btn" data-tid=${torrent.id}>Start</button>
                                        </div>
                                    </div>
                                </div>
                                `;
                            }
                            console.log("draw");
                            $(".torrents-container").append(`
                                <div class="torr torrent-container-${torrent.id} d-flex flex-column m-3" data-tid=${torrent.id}>
                                    ${torrent.torrentView}
                                    <div class="progress">
                                        <div class="progress-bar" role="progressbar" style="width: ${percent};" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">${widthperc}</div>
                                    </div>
                                </div>
                            `);
                        }
                    })
                }
            });

            socket.on('BlackbeardTransmission.get', function(torrents) {
                latestUpdateTime = Date.now();
                torrents.torrents.forEach((tor) => {
                    activeTorrents.forEach((item) => {
                        if (item.id == tor.id) {
                            item.leftUntilDone = tor.leftUntilDone;
                            item.rateDownload = tor.rateDownload;
                            item.percentDone = tor.percentDone;
                            item.status = tor.status;
                            item.lastUpdated = Date.now();
                        }
                    });
                });
            });
        }

        function initiateDragonSearch(cb) {

            getShows();

            var results_panel = $(".right-panel .selected-list-rp");

            $(document).on('keydown', function(e) {
                if ((e.ctrlKey || e.metaKey) && e.shiftKey && (String.fromCharCode(e.which).toLowerCase() === 'f')) {
                    $(".right-panel").toggleClass("show");
                    $("#dragonflySearch").val('');
                    $(".df-result-small").html("");
                    results_panel.html('');
                    if ($(".right-panel").hasClass("show")) {
                        setTimeout(function() {
                            $("#dragonflySearch").focus();
                        }, 200);
                    }
                }
            });
            $('#dragonflySearch').on('keyup', function(e) {
                switch (e.keyCode) {
                    case 13:

                        e.preventDefault();
                        $(".show-selected").click();

                        break;
                    case 40:

                        e.preventDefault();
                        $(".show-selected").removeClass("show-selected").next("a").addClass("show-selected");
                        if ($(".show-selected").length == 0) {
                            $(".df-result-btn").first().addClass("show-selected");
                        }

                        break;
                    case 38:

                        e.preventDefault();
                        $(".show-selected").removeClass("show-selected").prev("a").addClass("show-selected");
                        if ($(".show-selected").length == 0) {
                            $(".df-result-btn").first().addClass("show-selected");
                        }

                        break;
                    default:

                        searchterm = $(this).val();
                        showSearch = new Search(searchterm, allShows).go();
                        results_panel.html('');
                        if (showSearch.error) {
                            // console.log(clients.error);
                            $(".df-result-small").html("...");
                            if (showSearch.error == "No content") {
                                $(".df-result-small").html("");
                            }
                        } else {
                            var x = 0;
                            showSearch.matches.forEach(function(item) {
                                var details = `
                                <small class="df-show-result-details text-left">Unknown</small>
                            `;
                                var poster = `<div class="search-poster-img"></div>`;
                                var score = "?";
                                var genre = "?";
                                if (item.searchItem.omdb != undefined) {
                                    if (item.searchItem.omdb.Response == "False") {
                                        // console.log(item.searchItem)
                                    } else {
                                        // console.log(parseFloat(item.searchItem.omdb.imdbRating))
                                        score = parseFloat(item.searchItem.omdb.imdbRating);
                                        genre = item.searchItem.omdb.Genre;
                                        details = `
                                        <small class="df-show-result-details text-wrap text-left">${item.searchItem.omdb.Actors}</small>
                                    `;
                                        poster = `
                                <img class="img-fluid search-poster-img ml-auto" src="${item.searchItem.omdb.Poster}">
                                    `
                                    }
                                }
                                // if(item.count>1.8) {
                                var isSelected = (x == 0) ? " show-selected" : "";
                                results_panel.append(
                                    `<a href="#" class="btn${isSelected} btn-block p-0 mt-0 rounded-0 d-flex flex-row df-result-btn align-items-start border-top-0" data-show-id="${item.searchItem.id}">
                                            <div class="d-flex flex-column p-3 text-truncate flex-fill">
                                                <h6 class="df-show-result text-left justify-content-between text-truncate w-100 d-flex flex-row align-items-center">
                                                    ${item.searchItem.term}
                                                    <span>${score}</span>
                                                </h6>
                                               ${details}
                                               <small class="text-left text-secondary text-truncate">${genre}</small>
                                            </div>
                                            ${poster}
                                        </a>`
                                );
                                x++;
                                // }
                            });
                            var r = '';
                            if (x != 1) {
                                r = 's';
                            }
                            $(".df-result-small").html(x + " result" + r);
                            // console.log(clients.results);
                        }
                        break;
                }
            });
            cb();
        }

        function initiateUI() {

            $(".magnet-link-textarea").on("keyup", function(e) {
                if (e.keyCode == 13) {
                    $(".add-magnet-btn").click();
                }
            });

            $(".add-dropdown-toggle").on("click", function() {
                setTimeout(function() {
                    $(".magnet-link-textarea").focus();
                }, 200);
                $(".magnet-link-textarea").val('');
            });

            // torrent UI panel

            $(document.body).on("click", ".stop-torrent-btn", function() {
                socket.emit('BlackbeardTransmission.stop', $(this).data('tid'))
            });

            $(document.body).on("click", ".start-torrent-btn", function() {
                socket.emit('BlackbeardTransmission.start', $(this).data('tid'))
            });

            $(".stop-btn").on("click", function() {
                socket.emit('BlackbeardTransmission.stop-all')
            });

            $(".start-btn").on("click", function() {
                socket.emit('BlackbeardTransmission.start-all')
            });

            $(".remove-btn").on("click", function() {
                socket.emit('BlackbeardTransmission.remove-all')
            });

            $(".sort-btn").on("click", function() {
                socket.emit('BlackbeardTransmission.sort')
            });

            $(".restart-daemon-btn").on("click", function() {
                socket.emit('BlackbeardTransmission.restart-daemon')
            });

            $(".utility-btn").on("click", function() {
                socket.emit('BlackbeardTransmission.utility-function')
            });

            $(".add-magnet-btn").on("click", function() {
                socket.emit('BlackbeardTransmission.add-magnet', $(".magnet-link-textarea").val());
            });

            $(document).on("click", ".add-ep-magnet-btn", function() {
                let show = allShows.find(x=>x.id==$(this).data('show-id'))
                socket.emit('BlackbeardTransmission.add-magnet', {
                    magnetLink: $(this).data('magnet-link'),
                    showData: show
                });
            });

            $(".is-subscribed-btn").on("click", function() {
                var isSubscribed = ($(this).hasClass("btn-purple")) ? true : false;
                var id = $(".show-selected").data("show-id");
                var btn = $(this);
                $(".is-subscribed-btn").toggleClass("btn-primary btn-purple");
                if (isSubscribed) {
                    $(".right-panel-outer").removeClass("show");
                    $(".is-subscribed-btn").html('Not subscribed');
                } else {
                    $(".is-subscribed-btn").html('Subscribed');
                    $(".right-panel-outer").addClass("show");
                }
                socket.emit('Shows.toggleSubscribed', id);
            });

            $(document.body).on("click", ".df-result-btn", function() {
                var btn = $(this);
                var id = btn.data("show-id");
                allShows.forEach((show) => {
                    if (show.id == id) {
                        var isSubscribed = (show.subscribed) ? "Subscribed" : "Not subscribed";
                        var isSubscribedClass = (show.subscribed) ? "btn-purple" : "btn-primary";
                        $(".tv-show-title").html(show.omdb.Title);
                        $(".tv-show-actors").html(show.omdb.Actors);
                        $(".tv-show-plot").html(show.omdb.Plot);
                        $(".is-subscribed-btn").html(isSubscribed);
                        $(".is-subscribed-btn").removeClass("btn-purple btn-primary").addClass(isSubscribedClass);
                        $(".tv-show-poster-img").css("background-image", "url(" + show.omdb.Poster + ")");
                        $(".right-panel-inner").addClass("show");
                        if (show.subscribed) {
                            setTimeout(function() {
                                $(".right-panel-outer").addClass("show")
                            }, 200);
                        } else {

                            $(".right-panel-outer").removeClass("show")
                        }
                    }
                });
                $(".show-selected").removeClass("show-selected");
                btn.addClass("show-selected");
                socket.emit('Shows.get-rss-feed', id);
            });

            $(".show-search-btn").on("click", function() {
                $(".right-panel").addClass("show");
                setTimeout(function() {
                    $("#dragonflySearch").focus();
                }, 200);
            });

            $("body").on("click", function(e) {
                if ($(e.target).closest(".right-panel, .bottom-card").length == 0 && !rpmd) {
                    function hideInner() {
                        $(".right-panel-inner").removeClass("show");
                        setTimeout(function() {
                            $(".right-panel").removeClass("show");
                        }, 200);
                    }
                    if ($(".right-panel-outer").hasClass("show")) {
                        $(".right-panel-outer").removeClass("show");
                        setTimeout(hideInner, 200)
                    } else {
                        hideInner();
                    }
                }
                rpmd = false;
            });

            $(".right-panel").on("mousedown", function() {
                rpmd = true;
            })
        }

        function initiateLoops() {

            function update_loop() {
                socket.emit('BlackbeardTransmission.get')
            }

            function list_loop() {
                socket.emit('BlackbeardTransmission.get-info')
            }

            function display_loop() {
                activeTorrents.forEach((item) => {
                    if ($(".torrent-container-" + parseInt(item.id)).length == 0) {

                    } else {
                        // update torrent
                        if (item.leftUntilDone !== undefined) {
                            var widthperc = Math.round(item.percentDone * 10000) / 100;
                            if (parseFloat(widthperc) > 9) {
                                widthperc = widthperc + "%";
                            } else {
                                widthperc = '';
                            }
                            if (item.leftUntilDone == 0 || item.rateDownload == 0) {
                                $(".torrent-container-" + item.id + " .time").html("--");
                            } else {
                                var timeRemaining = Math.round(item.leftUntilDone / item.rateDownload);
                                prevtime = parseInt($(".torrent-container-" + item.id + " .time").data('prevtime'));
                                avgTimeLeft = parseInt(prevtime * 15 + timeRemaining) / 16;
                                avgTimeLeft = Math.round(avgTimeLeft);
                                var minutesleft = Math.floor(avgTimeLeft / 60);
                                var secondsleft = Math.floor(avgTimeLeft % 60);
                                if (secondsleft < 10) {
                                    secondsleft = "0" + secondsleft;
                                }
                                $(".torrent-container-" + item.id + " .time").html(minutesleft + ":" + secondsleft);
                                $(".torrent-container-" + item.id + " .time").data('prevtime', avgTimeLeft);
                            }
                            // $(".torrent-container-"+item.id+" .status").html(item.status);
                            $(".torrent-container-" + item.id + " .progress-bar").html(widthperc);
                            $(".torrent-container-" + item.id + " .progress-bar").css("width", Math.round(item.percentDone * 10000) / 100 + "%");
                        } else {
                            $(".torrent-container-" + item.id + " .time").html("--");
                        }
                        switch(item.status) {
                            case 4:
                                $(".torrent-container-" + item.id + " .start-torrent-btn").addClass("hide");
                                $(".torrent-container-" + item.id + " .stop-torrent-btn").removeClass("hide");
                            break;
                            case 0:
                                $(".torrent-container-" + item.id + " .start-torrent-btn").removeClass("hide");
                                $(".torrent-container-" + item.id + " .stop-torrent-btn").addClass("hide");
                            break;
                        }
                    }
                });
                // $(".torrent-total").html(activeTorrents.length);
            }

            function cleanup_loop() {
                activeTorrents.forEach((item, index, object) => {
                    if ((latestUpdateTime - item.lastUpdated) > 2500) {
                        console.log("remove");
                        object.splice(index, 1);
                        $(".torrent-container-" + item.id).remove();
                    }
                })

            }

            function animate_loop() {
                $(".progress-bar").each(function() {
                    if (Math.random() > 0.7) {
                        var bar = $(this);
                        bar.css("box-shadow", "0px 0px " + Math.round(Math.random() * 16) + 8 + "px 0px #ffeb00");
                    }
                });
            }

            updateLoop = setInterval(update_loop, 400);
            listLoop = setInterval(list_loop, 10000);
            displayLoop = setInterval(display_loop, 400);
            cleanupLoop = setInterval(cleanup_loop, 2000);
            animateLoop = setInterval(animate_loop, 300);

            list_loop();

            function update_feeds_panel() {
                $(".feeds-container").html('');
                feeds.feeds.forEach((feed) => {
                    $(".feeds-container").append(
                        `
                    <div class="d-flex flex-column">
                        <span class="rss-title text-truncate">${feed.name}</span>
                    </div>
                        `
                    )
                })
            }
        }

        function initiateSockets() {

            socket = io.connect('http://localhost:4000/web');

            socketListenersOn();

        }

        function onSocketConnection() {

            if (!uiInitiated) {

                initiateDragonSearch(() => {

                    initiateUI();
                    initiateLoops();

                    console.log("UI initiated");
                    uiInitiated = true;

                });

            }

        }

        window.onload = (e) => {
            $(".game-screen-options").toggleClass("hide");
            $("html").on("keyup", function(e) {
                if (e.keyCode == 13) {
                    $(".init-btn").click();
                }
            });
            setTimeout(function() {
                initBtn();
            }, 150);
            function initBtn() {
                initiateSockets();
                $("html").off("keyup");
                $("body").addClass("initiate");
                setTimeout(function() {
                    $(".game-screen").remove();
                }, 600);
            }
            $(".init-btn").on("click", initBtn);
        }
    </script>
</body>

</html>
